<!DOCTYPE html>
<html>

<head>

  <script src="{{ url_for('static', filename='dist/fhir-client-v2.js') }}"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>

  <style>
    #main {
      background: lightgray;
      margin: 1em;
      padding: 1em;
      font-size: 2em;
    }
  </style>
</head>

<body>

  <div id="main"></div>

  <script>

    var myApp = {}

    FHIR.oauth2.ready()
      .then(function (client) {
        myApp.smart = client
        doRequests()
      })

    async function doRequests() {
      var toInsert = ""
      var birthDate;
      var age; 
      var name; 
      var gender; 
      var genderCode; 
      var weight; 
      var weightUnit; 
      var height; 
      var heightUnit; 
      var bmi;
      var smokingCode;
      var smokingStatus;
      var hasNeverSmoked;
      console.log(myApp.smart)
      
      //1. get demographics
      var patient = await fetch(myApp.smart.state.serverUrl + "/Patient/" + myApp.smart.patient.id, {
        headers: {
          "Accept": "application/json+fhir",
          "Authorization": "Bearer " + myApp.smart.state.tokenResponse.access_token
        }
      }).then((res) => res.json());
 
      console.log(patient)
      birthDate = patient.birthDate;
      age = calculateAge(birthDate);
      name = patient.name[0].text;
      gender = patient.gender;
      genderCode = gender.toLowerCase() === "male" ? 1 : gender.toLowerCase() === "female" ? 0 : undefined;

      //2. get weight
      var loincs = [encodeURIComponent("http://loinc.org/29463-7")] 
      var weightObservations = await fetch(myApp.smart.state.serverUrl + "/Observation?patient=" + myApp.smart.patient.id+"&code=29463-7&_count=1&_sort=-date", {
        headers: {
          "Accept": "application/fhir+json",
          "Authorization": "Bearer " + myApp.smart.state.tokenResponse.access_token
        }
      }).then((res) => res.json());
      console.log(weightObservations)
      const weightObservation = weightObservations.entry?.[0]?.resource;
      weight = weightObservation?.valueQuantity?.value
      weightUnit = weightObservation?.valueQuantity?.unit;


      //3. get height
      loincs = [encodeURIComponent("http://loinc.org/8302-2")] 
      var heightObservations = await fetch(myApp.smart.state.serverUrl + "/Observation?patient=" + myApp.smart.patient.id+"&code=8302-2&_count=1&_sort=-date", {
        headers: {
          "Accept": "application/fhir+json",
          "Authorization": "Bearer " + myApp.smart.state.tokenResponse.access_token
        }
      }).then((res) => res.json());
      console.log(heightObservations)
      const heightObservation = heightObservations.entry?.[0]?.resource;
      height = heightObservation?.valueQuantity?.value
      heightUnit = heightObservation?.valueQuantity?.unit;

      bmi=calculateBMIWithConversion(weight,weightUnit,height,heightUnit)

      //4. get smoking status
      loincs = [encodeURIComponent("http://loinc.org/72166-2")] 
      var smokingObservations = await fetch(myApp.smart.state.serverUrl + "/Observation?patient=" + myApp.smart.patient.id+"&code=72166-2&_count=1&_sort=-date", {
        headers: {
          "Accept": "application/fhir+json",
          "Authorization": "Bearer " + myApp.smart.state.tokenResponse.access_token
        }
      }).then((res) => res.json());
      console.log(smokingObservations)
      const smokingObservation = smokingObservations.entry?.[0]?.resource;
      if (smokingObservation) {
        const coding = smokingObservation.valueCodeableConcept?.coding?.[0];
        smokingCode = coding?.code; // Extract SNOMED code
        smokingStatus = coding?.display; // Extract human-readable description
        if(smokingCode == "266919005"){
          hasNeverSmoked=true
        }else if(smokingCode != "266927001"){
          hasNeverSmoked=false;
        }
      }else{
        smokingStatus="unknown"
      }

      var input = {
        "birthDate": birthDate,
        "age": age,
        "gender" : gender,
        "genderCode" : genderCode,
        "name": name,
        "weight": weight,
        "weightUnit": weightUnit,
        "height": height,
        "bmi":bmi,
        "heightUnit": heightUnit,
        "smokingStatus": smokingStatus,
        "hasNeverSmoked": hasNeverSmoked
      }
      console.log(input)
     // //if there is no entry, then there was no test found
      //       if (!response.entry[0]){

      //         toInsert += "We could not find you were tested for HgA1C at this provider."

      //       }else{
      toInsert += "The patient data is <br>" + JSON.stringify(input)

      // toInsert += "Your HgA1C was tested on "+response.entry[0].resource.effectiveDateTime+"<br/><br/>"

      // toInsert += "Your HgA1C was "+response.entry[0].resource.valueQuantity.value+"<br/><br/>"

      // toInsert += "<a href='https://en.wikipedia.org/wiki/Glycated_hemoglobin'>According to wikipedia</a>, A1c is measured primarily to determine the three-month average blood sugar level and can be used as a diagnostic test for diabetes mellitus.  <5.7%	Normal, 5.7-6.4%	Prediabetes, >6.5%	Diabetes."
      // }

      $("#main").html(toInsert)

    }

    function calculateBMIWithConversion(weight, weightUnit, height, heightUnit) {
      // Convert weight to kilograms if necessary
      if (weightUnit.toLowerCase() === "lbs") {
        weight = weight * 0.453592; // 1 lb = 0.453592 kg
      } else if (weightUnit.toLowerCase() !== "kg") {
        return undefined;
      }
    
      // Convert height to meters if necessary
      if (heightUnit.toLowerCase() === "cm") {
        height = height / 100; // 1 cm = 0.01 m
      } else if (heightUnit.toLowerCase() === "in") {
        height = height * 0.0254; // 1 inch = 0.0254 m
      } else if (heightUnit.toLowerCase() !== "m") {
        return undefined;
      }
    
      // Ensure valid height and weight
      if (weight <= 0 || height <= 0) {
        return undefined;
      }
    
      // Calculate BMI
      const bmi = weight / (height ** 2);
      return Math.round(bmi * 100) / 100; // Round to two decimal places
    }

    function calculateAge(birthDate) {
      // Parse the birth date string into a Date object
      const birthDateObj = new Date(birthDate);
      
      // Get today's date
      const today = new Date();
      
      // Calculate the age
      let age = today.getFullYear() - birthDateObj.getFullYear();
    
      // Adjust if the birthday hasn't occurred yet this year
      const isBirthdayPassed = (
        today.getMonth() > birthDateObj.getMonth() || 
        (today.getMonth() === birthDateObj.getMonth() && today.getDate() >= birthDateObj.getDate())
      );
      
      if (!isBirthdayPassed) {
        age--;
      }
    
      return age;
    }
    
  </script>

</body>

</html>