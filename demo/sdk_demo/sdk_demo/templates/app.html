<!DOCTYPE html>
<html>

<head>

  <script src="{{ url_for('static', filename='dist/fhir-client-v2.js') }}"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>

  <style>
    #main {
      background: lightgray;
      margin: 1em;
      padding: 1em;
      font-size: 2em;
    }
  </style>
</head>

<body>

  <div id="main"></div>

  <script>

    var myApp = {}

    FHIR.oauth2.ready()
      .then(function (client) {
        myApp.smart = client
        doRequests()
      })

    async function doRequests() {
      var toInsert = ""
      var birthDate 
      var name 
      var gender 
      var weight; 
      var weightUnit; 
      var height; 
      var heightUnit; 

      console.log(myApp.smart)
      
      //1. get demographics
      var patient = await fetch(myApp.smart.state.serverUrl + "/Patient/" + myApp.smart.patient.id, {
        headers: {
          "Accept": "application/json+fhir",
          "Authorization": "Bearer " + myApp.smart.state.tokenResponse.access_token
        }
      }).then((res) => res.json());
 
      console.log(patient)
      var birthDate = patient.birthDate;
      var name = patient.name[0].text;
      var gender = patient.gender;

      //2. get weight
      var loincs = [encodeURIComponent("http://loinc.org/29463-7")] 
      var weightObservations = await fetch(myApp.smart.state.serverUrl + "/Observation?patient=" + myApp.smart.patient.id+"&code=29463-7&_count=1&_sort=-date", {
        headers: {
          "Accept": "application/fhir+json",
          "Authorization": "Bearer " + myApp.smart.state.tokenResponse.access_token
        }
      }).then((res) => res.json());
      console.log(weightObservations)
      const weightObservation = weightObservations.entry?.[0]?.resource;
      weight = weightObservation?.valueQuantity?.value
      weightUnit = weightObservation?.valueQuantity?.unit;


      //3. get height
      loincs = [encodeURIComponent("http://loinc.org/8302-2")] 
      var heightObservations = await fetch(myApp.smart.state.serverUrl + "/Observation?patient=" + myApp.smart.patient.id+"&code=8302-2&_count=1&_sort=-date", {
        headers: {
          "Accept": "application/fhir+json",
          "Authorization": "Bearer " + myApp.smart.state.tokenResponse.access_token
        }
      }).then((res) => res.json());
      console.log(heightObservations)
      const heightObservation = heightObservations.entry?.[0]?.resource;
      height = heightObservation?.valueQuantity?.value
      heightUnit = heightObservation?.valueQuantity?.unit;

      //4. get smoking status
      loincs = [encodeURIComponent("http://loinc.org/72166-2")] 
      var smokingObservations = await fetch(myApp.smart.state.serverUrl + "/Observation?patient=" + myApp.smart.patient.id+"&code=8302-2&_count=1&_sort=-date", {
        headers: {
          "Accept": "application/fhir+json",
          "Authorization": "Bearer " + myApp.smart.state.tokenResponse.access_token
        }
      }).then((res) => res.json());
      console.log(smokingObservations)
      const smokingObservation = smokingObservations.entry?.[0]?.resource;
      const smokingStatus = smokingObservation.valueCodeableConcept?.text || "Unknown";


      var input = {
        "birthDate": birthDate,
        "gender" : gender,
        "name": name,
        "weight": weight,
        "weightUnit": weightUnit,
        "height": height,
        "heightUnit": heightUnit,
        "smoking": smokingStatus
      }
      console.log(input)
     // //if there is no entry, then there was no test found
      //       if (!response.entry[0]){

      //         toInsert += "We could not find you were tested for HgA1C at this provider."

      //       }else{
      toInsert += "The patient data is <br>" + JSON.stringify(input)

      // toInsert += "Your HgA1C was tested on "+response.entry[0].resource.effectiveDateTime+"<br/><br/>"

      // toInsert += "Your HgA1C was "+response.entry[0].resource.valueQuantity.value+"<br/><br/>"

      // toInsert += "<a href='https://en.wikipedia.org/wiki/Glycated_hemoglobin'>According to wikipedia</a>, A1c is measured primarily to determine the three-month average blood sugar level and can be used as a diagnostic test for diabetes mellitus.  <5.7%	Normal, 5.7-6.4%	Prediabetes, >6.5%	Diabetes."
      // }

      $("#main").html(toInsert)

    }
  </script>

</body>

</html>